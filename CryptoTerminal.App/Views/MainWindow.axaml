<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:sp="clr-namespace:ScottPlot.Avalonia;assembly=ScottPlot.Avalonia"
        xmlns:vm="using:CryptoTerminal.Core.ViewModels"
        xmlns:conv="using:CryptoTerminal.App.Converters"
        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"

        x:Class="CryptoTerminal.App.Views.MainWindow"
        x:DataType="vm:MainViewModel"
        Title="{Binding Title}">

    <Window.Styles>
        <StyleInclude Source="avares://Avalonia.Controls.DataGrid/Themes/Fluent.xaml" />
    </Window.Styles>

    <Window.Resources>
        <conv:BoolToColorConverter x:Key="BoolToColorConverter" />
    </Window.Resources>


    <Grid RowDefinitions="*, 200">

        <!-- 上半区：左右分栏 -->
        <Grid Grid.Row="0" ColumnDefinitions="*, 250">

            <!-- 左侧：图表区域 -->
            <Grid Grid.Column="0" RowDefinitions="Auto, *">
                <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10" Spacing="10">
                    <Button Content="Refresh Data" Command="{Binding LoadDataCommand}" />
                    <TextBlock Text="{Binding Title}" VerticalAlignment="Center" FontWeight="Bold" />
                </StackPanel>
                <sp:AvaPlot Name="ChartPlot" Grid.Row="1" />
            </Grid>

            <!-- 右侧：交易控制面板 -->
            <Border Grid.Column="1" Background="#f8f9fa" BorderBrush="#ddd" BorderThickness="1,0,0,0" Padding="15">
                <StackPanel Spacing="15">
                    <!-- ... 这里的内容不用变，直接复制你原来的 ... -->
                    <TextBlock Text="Trade Panel" FontSize="18" FontWeight="Bold" Margin="0,0,0,10" />

                    <Grid ColumnDefinitions="*, *">
                        <Button Grid.Column="0" Content="Long" Command="{Binding SetLongModeCommand}"
                                HorizontalAlignment="Stretch" Margin="0,0,5,0"
                                Background="{Binding TradeSetup.IsLong, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Long}" />
                        <Button Grid.Column="1" Content="Short" Command="{Binding SetShortModeCommand}"
                                HorizontalAlignment="Stretch" Margin="5,0,0,0"
                                Background="{Binding TradeSetup.IsLong, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Short}" />
                    </Grid>

                    <StackPanel>
                        <TextBlock Text="Entry Price" />
                        <TextBox Text="{Binding TradeSetup.EntryPrice, Mode=TwoWay, StringFormat='F2'}" />
                    </StackPanel>

                    <StackPanel>
                        <TextBlock Text="Take Profit" />
                        <TextBox Text="{Binding TradeSetup.TpPrice, Mode=TwoWay, StringFormat='F2'}" />
                    </StackPanel>

                    <StackPanel>
                        <TextBlock Text="Stop Loss" />
                        <TextBox Text="{Binding TradeSetup.SlPrice, Mode=TwoWay, StringFormat='F2'}" />
                    </StackPanel>
                    <StackPanel>
                        <TextBlock Text="Quantity (BTC)"/>
                        <!-- 确保 Binding 路径是 TradeSetup.Quantity -->
                        <TextBox Text="{Binding TradeSetup.Quantity, Mode=TwoWay}" Watermark="Amount"/>
                    </StackPanel>

                    <Border Background="White" BorderBrush="#eee" BorderThickness="1" Padding="10" Margin="0,10">
                        <StackPanel Spacing="5">
                            <TextBlock Text="{Binding TradeSetup.RiskRewardLabel}" FontWeight="Bold" />
                        </StackPanel>
                    </Border>

                    <!-- 注意：这里必须绑定 Command！之前你只写了 Content -->
                    <Button Content="Place Order"
                            Command="{Binding PlaceOrderCommand}"
                            HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                            FontWeight="Bold" Background="#0ECB81" Foreground="White"
                            Height="40" IsEnabled="{Binding TradeSetup.IsValid}" />

                    <Button Content="Cancel / Exit" Command="{Binding CancelPreviewCommand}"
                            HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                            Background="Transparent" BorderBrush="Gray" BorderThickness="1" />
                </StackPanel>
            </Border>
        </Grid>


        <!-- 下半区：底部订单列表 -->
        <DataGrid Grid.Row="1"
                  ItemsSource="{Binding RealOrders}"
                  AutoGenerateColumns="False"
                  IsReadOnly="True"
                  GridLinesVisibility="All"
                  BorderThickness="0,1,0,0"
                  BorderBrush="#444"
                  Background="Transparent"
                  RowBackground="Transparent"
                  HeadersVisibility="Column">

            <DataGrid.Columns>
                <!-- 订单 ID -->
                <DataGridTextColumn Header="ID" Binding="{Binding Id}" Width="80" />

                <!-- 交易对 -->
                <DataGridTextColumn Header="Symbol" Binding="{Binding Symbol}" Width="100" />

                <!-- 方向 (Side) -->
                <DataGridTextColumn Header="Side" Binding="{Binding Side}" Width="60">
                    <!-- 进阶：你可以给这一列加颜色转换器，让 Buy 变绿 Sell 变红 -->
                </DataGridTextColumn>

                <!-- 类型 -->
                <DataGridTextColumn Header="Type" Binding="{Binding Type}" Width="80" />

                <!-- 价格 (格式化 F2) -->
                <DataGridTextColumn Header="Price" Binding="{Binding Price, StringFormat='{}{0:F2}'}" Width="100" />

                <!-- 数量 -->
                <DataGridTextColumn Header="Qty" Binding="{Binding Quantity}" Width="100" />

                <!-- 状态 -->
                <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="*" />

                <!-- 操作列 (按钮) -->
                <DataGridTemplateColumn Header="Action" Width="80">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Button Content="Cancel" FontSize="10"
                                    x:CompileBindings="False"
                                    Background="#F6465D" Foreground="White"
                                    Padding="5,2" HorizontalAlignment="Center"
                                    Command="{Binding $parent[Window].DataContext.CancelOrderCommand}"
                                    CommandParameter="{Binding .}" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>

    </Grid>

</Window>